## 2.4 Проектирование модуля интеллектуальной обработки обращений (intent classification)

Модуль интеллектуальной обработки обращений предназначен для повышения удобства взаимодействия пользователя с интернет-магазином в Telegram. В отличие от командного интерфейса, где пользователь должен помнить список команд и формат параметров, интеллектуальный модуль принимает текстовый запрос в свободной форме и формирует подсказку: какие товары могут подойти, какие действия выполнить дальше и какой командой оформить покупку.

В рамках прототипа tg-shop-ai интеллектуальная обработка реализована в виде классификации намерения (intent classification) и генерации ответов по шаблонам на основе данных каталога. Такой подход обеспечивает воспроизводимость и прозрачность поведения (важно для ВКР): каждому запросу соответствует конкретный сценарий и понятный набор обращений к базе данных. При необходимости модуль может быть расширен до ML/LLM-решения, однако для демонстрации архитектуры и сквозного сценария (бот → БД → логирование) достаточно прототипа.

### Входные и выходные данные
**Вход:** текст запроса пользователя (команда `/ai <текст>`), а также идентификатор пользователя Telegram (`tg_id`), по которому определяется внутренний `user_id` в БД.  
**Выход:** текстовая рекомендация/подсказка пользователю и, при необходимости, инструкция по следующему действию (например, `/buy <SKU>`).

### Алгоритм обработки запроса
Обработка выполняется последовательностью шагов:
1. Нормализация входного текста (удаление лишних пробелов, приведение к нижнему регистру).
2. Определение интента по ключевым словам и контексту запроса.
3. Формирование ответа:
   - для интента “рекомендация/подбор” выбираются активные товары из БД и формируется короткий список предложений;
   - для интента “справка/помощь” формируется инструкция по доступным действиям (каталог, покупка);
   - для неизвестного интента возвращается нейтральная подсказка и пример корректного запроса.
4. Логирование запроса и ответа в таблицу `ai_logs` (для последующего анализа качества и частоты обращений).

### Логирование и трассируемость
Каждый запрос `/ai` сохраняется в БД в виде записи `ai_logs` (поля: `user_id`, `prompt`, `response`, `created_at`). Это обеспечивает трассируемость работы интеллектуального компонента и позволяет:
- проверять корректность поведения на тестовых сценариях;
- собирать статистику по запросам пользователей;
- в дальнейшем улучшать правила классификации или заменить модуль на обучаемую модель.

Свод интентов, условия выбора и соответствующие действия системы приведены в таблице 3.

**Таблица 3 — Интенты модуля интеллектуальной обработки обращений tg-shop-ai**

| ID | Интент | Примеры запросов | Условие распознавания (правило) | Действие системы | Результат пользователю | Логирование |
|---|---|---|---|---|---|---|
| AI1 | Рекомендация товаров | «посоветуй что купить», «что выбрать?» | ключевые слова: *посоветуй*, *выбери*, *рекоменд*, *что купить* | выборка активных товаров из `products` (топ-N) | список 3 предложений + инструкция `/buy <SKU>` | запись в `ai_logs` |
| AI2 | Запрос каталога/товаров | «покажи товары», «каталог» | ключевые слова: *каталог*, *товары*, *ассортимент* | выборка активных товаров из `products` | подсказка перейти к `/catalog` (или краткий список) | запись в `ai_logs` |
| AI3 | Помощь по покупке | «как купить?», «как оформить заказ?» | ключевые слова: *как купить*, *заказ*, *оформить* | формирование инструкции по использованию `/buy <SKU>` | пошаговая подсказка + пример команды | запись в `ai_logs` |
| AI4 | Прочее/неопределённо | любой другой текст | нет совпадений по правилам | формирование общего ответа | пример запроса + подсказка `/catalog`, `/buy` | запись в `ai_logs` |
